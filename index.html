<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Queue System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">

    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; }
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            50% { box-shadow: 0 0 0 20px rgba(16, 185, 129, 0); }
        }
        .animate-pulse-green { animation: pulse-green 2s infinite; }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, update, remove, get } 
        from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // ==========================================
        // --- ส่วนตั้งค่า FIREBASE (แก้ไขตรงนี้) ---
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDGYuI3yxJbUTc6T_0pm6WiEKZul11tXS0",
  authDomain: "suchartwork-1487382986748.firebaseapp.com",
  databaseURL: "https://suchartwork-1487382986748.firebaseio.com",
  projectId: "suchartwork-1487382986748",
  storageBucket: "suchartwork-1487382986748.firebasestorage.app",
  messagingSenderId: "353884592527",
  appId: "1:353884592527:web:a78fc0a891ba458aeb13fa"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Pre-load voices
        let allVoices = [];
        window.speechSynthesis.onvoiceschanged = () => {
            allVoices = window.speechSynthesis.getVoices();
        };

        const params = new URLSearchParams(window.location.search);
        const mode = params.get('mode') || 'kiosk'; 
        const AVG_SERVICE_TIME = 5; 

        const renderApp = () => {
            const appDiv = document.getElementById('app');
            if (mode === 'kiosk') renderKiosk(appDiv);
            else if (mode === 'user') renderUser(appDiv);
            else if (mode === 'staff') renderStaff(appDiv);
            else if (mode === 'tv') renderTV(appDiv);
        };

        // ==========================================
        // 1. KIOSK MODE (เพิ่มปุ่ม Save Image)
        // ==========================================
        const renderKiosk = (container) => {
            let resetTimer = null;
            let currentUnsubscribe = null;

            const resetKioskUI = () => {
                const resultBox = document.getElementById('kiosk-result');
                const btnGet = document.getElementById('btn-get-q');
                const welcome = document.getElementById('welcome-text');
                
                if(resultBox) resultBox.classList.add('hidden');
                if(btnGet) btnGet.style.display = 'flex';
                if(welcome) welcome.style.display = 'block';
                
                if(resetTimer) clearTimeout(resetTimer);
                if(currentUnsubscribe) currentUnsubscribe(); 
            };

            container.innerHTML = `
                <div class="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-blue-600 to-blue-800 text-white p-4">
                    <div class="bg-white text-gray-800 p-8 rounded-3xl shadow-2xl text-center max-w-md w-full min-h-[450px] flex flex-col justify-center relative">
                        
                        <div id="welcome-text">
                            <h1 class="text-3xl font-bold mb-2">ยินดีต้อนรับ</h1>
                            <p class="text-gray-500 mb-8">กรุณากดปุ่มเพื่อรับบัตรคิว</p>
                        </div>
                        
                        <button id="btn-get-q" class="w-full bg-blue-600 hover:bg-blue-700 text-white text-2xl font-bold py-6 rounded-2xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3">
                            <i class="fa-solid fa-ticket"></i> กดรับคิว
                        </button>

                        <div id="kiosk-result" class="hidden w-full animate-fade-in flex flex-col items-center">
                            
                            <div id="ticket-card" class="bg-white p-6 rounded-xl border-2 border-dashed border-gray-300 w-full mb-4">
                                <h3 class="text-gray-400 text-sm font-bold uppercase tracking-wider mb-2">Smart Queue Ticket</h3>
                                <div id="q-number" class="text-7xl font-black text-blue-600 my-2 tracking-tighter leading-none"></div>
                                <div class="text-gray-400 text-xs mb-4" id="q-time"></div>
                                
                                <div class="bg-gray-50 p-2 rounded-lg inline-block">
                                    <div id="qr-code"></div>
                                </div>
                                <p class="text-xs text-red-500 font-bold mt-2">สแกนเพื่อติดตามคิว</p>
                            </div>

                            <div class="flex gap-2 w-full">
                                <button id="btn-save-img" class="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white py-3 rounded-xl font-bold text-sm shadow-md transition">
                                    <i class="fa-solid fa-download"></i> บันทึกรูป
                                </button>
                                <button id="btn-cancel" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-600 py-3 rounded-xl font-bold text-sm transition">
                                    ปิดหน้าต่าง
                                </button>
                            </div>
                            <p class="text-xs text-gray-300 mt-4">(ปิดอัตโนมัติใน 30 วินาที)</p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('btn-get-q').onclick = () => {
                const qRef = push(ref(db, 'queues'));
                const qNum = "A" + Math.floor(100 + Math.random() * 900);
                const now = new Date();
                const timeString = now.toLocaleDateString('th-TH') + ' ' + now.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'});
                
                set(qRef, {
                    number: qNum,
                    status: 'waiting',
                    timestamp: Date.now(),
                    scanned: false 
                });

                // UI Update
                document.getElementById('btn-get-q').style.display = 'none';
                document.getElementById('welcome-text').style.display = 'none';
                
                document.getElementById('q-number').innerText = qNum;
                document.getElementById('q-time').innerText = timeString;
                document.getElementById('kiosk-result').classList.remove('hidden');
                
                // QR Generation (ใส่ crossOrigin='anonymous' เพื่อให้ html2canvas ทำงานได้)
                const trackingUrl = `${window.location.origin}${window.location.pathname}?mode=user&id=${qRef.key}`;
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=${encodeURIComponent(trackingUrl)}`;
                document.getElementById('qr-code').innerHTML = `<img src="${qrUrl}" alt="QR" class="mx-auto mix-blend-multiply" crossOrigin="anonymous" />`;

                // Logic Save Image
                document.getElementById('btn-save-img').onclick = () => {
                    const ticketElement = document.getElementById('ticket-card');
                    html2canvas(ticketElement, { useCORS: true, scale: 2 }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `Queue-${qNum}.png`;
                        link.href = canvas.toDataURL("image/png");
                        link.click();
                    }).catch(err => alert("บันทึกภาพไม่สำเร็จ: " + err));
                };

                // Auto Close Timer
                resetTimer = setTimeout(() => resetKioskUI(), 30000);
                
                // Listen for Scan
                currentUnsubscribe = onValue(qRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data && data.scanned === true) resetKioskUI();
                });
            };
            document.getElementById('btn-cancel').onclick = resetKioskUI;
        };

        // ==========================================
        // 2. USER MODE
        // ==========================================
        const renderUser = (container) => {
            const ticketId = params.get('id');
            if (!ticketId) { container.innerHTML = `<div class="p-10 text-center">ไม่พบข้อมูลคิว</div>`; return; }
            update(ref(db, 'queues/' + ticketId), { scanned: true });

            container.innerHTML = `
                <div class="min-h-screen bg-gray-50 flex flex-col items-center p-6 transition-colors duration-500" id="user-bg">
                    <div class="bg-white w-full max-w-sm rounded-3xl shadow-xl p-8 text-center mt-10 relative overflow-hidden">
                        <div id="status-badge" class="absolute top-0 left-0 w-full h-2 bg-gray-300"></div>
                        <p class="text-gray-500 mt-4">คิวของคุณ</p>
                        <h1 id="my-q" class="text-6xl font-black text-gray-800 my-2">-</h1>
                        <div class="bg-gray-50 rounded-xl p-4 my-6 border border-gray-100">
                            <p class="text-lg font-bold text-gray-700" id="status-text">กำลังโหลด...</p>
                            <div id="eta-box" class="mt-2 text-sm text-gray-500">
                                อีกประมาณ <span id="eta-time" class="text-blue-600 font-bold text-xl">-</span> นาที
                            </div>
                        </div>
                        <div class="text-xs text-gray-400"><i class="fa-solid fa-bell"></i> ระบบจะเปลี่ยนสีหน้าจอเมื่อถึงคิว</div>
                    </div>
                    <div id="q-info" class="mt-8 text-gray-400 text-sm"></div>
                </div>
            `;

            onValue(ref(db, 'queues'), (snapshot) => {
                const allData = snapshot.val() || {};
                const myData = allData[ticketId];
                if (!myData) { document.getElementById('status-text').innerText = "คิวนี้ถูกยกเลิก"; return; }

                document.getElementById('my-q').innerText = myData.number;
                const bg = document.getElementById('user-bg');
                const badge = document.getElementById('status-badge');
                const statusTxt = document.getElementById('status-text');

                if (myData.status === 'serving') {
                    bg.className = "min-h-screen flex flex-col items-center p-6 bg-green-500";
                    badge.className = "absolute top-0 left-0 w-full h-4 bg-green-600 animate-pulse";
                    statusTxt.innerHTML = `เชิญที่ช่องบริการ <span class="text-3xl block mt-2 text-green-600">${myData.counter}</span>`;
                    document.getElementById('eta-box').style.display = 'none';
                } else if (myData.status === 'waiting') {
                    bg.className = "min-h-screen flex flex-col items-center p-6 bg-gray-50";
                    badge.className = "absolute top-0 left-0 w-full h-2 bg-yellow-400";
                    statusTxt.innerText = "กำลังรอเรียก...";
                    document.getElementById('eta-box').style.display = 'block';
                    let qAhead = 0;
                    Object.values(allData).forEach(q => { if (q.status === 'waiting' && q.timestamp < myData.timestamp) qAhead++; });
                    document.getElementById('eta-time').innerText = Math.ceil((qAhead * AVG_SERVICE_TIME) / 3) || 1;
                    document.getElementById('q-info').innerText = `มีคิวรอก่อนหน้าคุณ ${qAhead} คิว`;
                }
            });
        };

        // ==========================================
        // 3. STAFF MODE
        // ==========================================
        const renderStaff = (container) => {
            let currentCounter = 1;
            let currentQID = null;

            container.innerHTML = `
                <div class="min-h-screen bg-slate-100 p-4 md:p-8">
                    <div class="max-w-4xl mx-auto">
                        <div class="bg-white p-4 rounded-xl shadow-sm mb-6 flex justify-between items-center flex-wrap gap-4">
                            <h1 class="text-xl font-bold text-slate-700"><i class="fa-solid fa-user-tie"></i> Staff Console</h1>
                            <div class="flex items-center gap-2 bg-slate-100 p-2 rounded-lg">
                                <span class="text-sm text-slate-500">Counter:</span>
                                <select id="counter-select" class="bg-transparent font-bold text-blue-600 outline-none">
                                    <option value="1">No. 1</option>
                                    <option value="2">No. 2</option>
                                    <option value="3">No. 3</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-xl shadow-md text-center border-t-4 border-blue-500">
                                <h2 class="text-gray-400 text-sm uppercase tracking-wide">กำลังให้บริการ</h2>
                                <div id="staff-current-q" class="text-6xl font-black text-slate-800 my-8 min-h-[80px]">-</div>
                                <button id="btn-finish" disabled class="w-full bg-red-500 hover:bg-red-600 disabled:bg-gray-300 text-white font-bold py-3 rounded-lg transition">
                                    <i class="fa-solid fa-check"></i> จบงาน (Finish)
                                </button>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-md border-t-4 border-green-500 flex flex-col">
                                <div class="flex justify-between items-end mb-4">
                                    <div>
                                        <h2 class="text-gray-400 text-sm uppercase">คิวรอ</h2>
                                        <div class="text-3xl font-bold" id="staff-wait-count">0</div>
                                    </div>
                                    <button id="btn-call" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg active:scale-95 transition">
                                        เรียกคิวถัดไป <i class="fa-solid fa-bullhorn ml-2"></i>
                                    </button>
                                </div>
                                <div class="flex-1 overflow-y-auto max-h-[300px] bg-slate-50 rounded p-2">
                                    <ul id="staff-wait-list" class="space-y-2 text-sm"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-center mt-8"><button id="btn-reset" class="text-xs text-red-300 underline">Reset System</button></div>
                </div>
            `;

            const updateUI = (data) => {
                const queues = Object.entries(data || {}).map(([k, v]) => ({ id: k, ...v }));
                const myServing = queues.find(q => q.status === 'serving' && parseInt(q.counter) === currentCounter);
                
                if (myServing) {
                    currentQID = myServing.id;
                    document.getElementById('staff-current-q').innerText = myServing.number;
                    document.getElementById('btn-finish').disabled = false;
                    document.getElementById('btn-call').disabled = true;
                    document.getElementById('btn-call').classList.add('opacity-50');
                } else {
                    currentQID = null;
                    document.getElementById('staff-current-q').innerText = "-";
                    document.getElementById('btn-finish').disabled = true;
                    document.getElementById('btn-call').disabled = false;
                    document.getElementById('btn-call').classList.remove('opacity-50');
                }

                const waiting = queues.filter(q => q.status === 'waiting').sort((a,b) => a.timestamp - b.timestamp);
                document.getElementById('staff-wait-count').innerText = waiting.length;
                document.getElementById('staff-wait-list').innerHTML = waiting.map(q => 
                    `<li class="flex justify-between p-2 bg-white rounded shadow-sm">
                        <span class="font-bold text-slate-700">${q.number}</span>
                        <span class="text-gray-400 text-xs">${new Date(q.timestamp).toLocaleTimeString()}</span>
                     </li>`
                ).join('');
            };

            document.getElementById('counter-select').onchange = (e) => {
                currentCounter = parseInt(e.target.value);
                get(ref(db, 'queues')).then(snap => updateUI(snap.val()));
            };
            document.getElementById('btn-call').onclick = async () => {
                const snap = await get(ref(db, 'queues'));
                const queues = Object.entries(snap.val() || {}).map(([k,v]) => ({id:k, ...v}));
                const nextQ = queues.filter(q => q.status === 'waiting').sort((a,b) => a.timestamp - b.timestamp)[0];
                if (nextQ) update(ref(db, `queues/${nextQ.id}`), { status: 'serving', counter: currentCounter, callTime: Date.now() });
                else alert("ไม่มีคิวรอ");
            };
            document.getElementById('btn-finish').onclick = () => { if (currentQID) update(ref(db, `queues/${currentQID}`), { status: 'done' }); };
            document.getElementById('btn-reset').onclick = () => { if(confirm('ลบข้อมูลทั้งหมด?')) set(ref(db, 'queues'), null); }
            onValue(ref(db, 'queues'), (snap) => updateUI(snap.val()));
        };

        // ==========================================
        // 4. TV DISPLAY MODE
        // ==========================================
        const renderTV = (container) => {
            let lastAnnounce = "";

            container.innerHTML = `
                <div class="relative w-screen h-screen bg-slate-900 text-white overflow-hidden flex">
                    <div id="sound-overlay" class="absolute inset-0 bg-black/90 z-50 flex items-center justify-center cursor-pointer">
                        <div class="text-center">
                            <i class="fa-solid fa-volume-high text-6xl mb-4 text-emerald-400 animate-bounce"></i>
                            <h2 class="text-2xl font-bold">คลิกที่นี่เพื่อเปิดใช้งานหน้าจอ</h2>
                        </div>
                    </div>
                    <div class="w-2/3 p-8 flex flex-col border-r border-slate-800">
                        <h1 class="text-4xl font-bold text-slate-400 mb-8 tracking-wider">กำลังเรียก <span class="text-emerald-500">NOW SERVING</span></h1>
                        <div id="tv-serving-list" class="grid grid-cols-1 gap-6"></div>
                    </div>
                    <div class="w-1/3 bg-slate-800 p-8 flex flex-col shadow-2xl">
                        <h2 class="text-2xl font-bold text-slate-400 mb-6 pb-4 border-b border-slate-700">คิวถัดไป / NEXT</h2>
                        <ul id="tv-waiting-list" class="space-y-4 text-2xl"></ul>
                        <div class="mt-auto bg-slate-700 rounded-xl p-4 flex items-center gap-4">
                            <div class="bg-white p-1 rounded"><i class="fa-solid fa-qrcode text-black text-4xl"></i></div>
                            <div><p class="text-sm text-slate-400">สแกนเพื่อรับคิว</p><p class="text-lg font-bold text-white">Smart Queue</p></div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('sound-overlay').onclick = function() {
                this.remove();
                speak("ระบบพร้อมทำงาน");
            };

            const speak = (text) => {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'th-TH';
                utterance.rate = 0.9;
                
                const voices = window.speechSynthesis.getVoices();
                const femaleVoice = voices.find(v => 
                    v.lang === 'th-TH' && 
                    (v.name.includes('Female') || v.name.includes('Wanya') || v.name.includes('Kanya') || v.name.includes('Premwadee'))
                );
                if (femaleVoice) utterance.voice = femaleVoice;

                window.speechSynthesis.speak(utterance);
            };

            onValue(ref(db, 'queues'), (snapshot) => {
                const queues = Object.values(snapshot.val() || {});
                const serving = queues.filter(q => q.status === 'serving').sort((a,b) => b.callTime - a.callTime);
                
                if (serving.length > 0) {
                    const latest = serving[0];
                    const uniqueKey = latest.number + latest.callTime;
                    if (lastAnnounce !== uniqueKey) {
                        lastAnnounce = uniqueKey;
                        speak(`เชิญคิว, ${latest.number},, ที่ช่องบริการ, ${latest.counter} ค่ะ`);
                    }
                }

                document.getElementById('tv-serving-list').innerHTML = serving.map((q, idx) => {
                    const isNew = idx === 0; 
                    return `
                    <div class="${isNew ? 'bg-white text-slate-900 border-l-8 border-emerald-500 animate-pulse-green' : 'bg-slate-700 text-slate-400 border-l-8 border-slate-500'} 
                        p-6 rounded-xl shadow-lg flex justify-between items-center transition-all">
                        <div>
                            <span class="text-xl block opacity-70">หมายเลขคิว</span>
                            <span class="text-8xl font-black tracking-tighter">${q.number}</span>
                        </div>
                        <div class="text-right">
                            <span class="text-2xl block opacity-70">ช่องบริการ</span>
                            <span class="text-6xl font-bold ${isNew ? 'text-blue-600' : 'text-slate-200'}">${q.counter}</span>
                        </div>
                    </div>`;
                }).join('');

                const waiting = queues.filter(q => q.status === 'waiting').sort((a,b) => a.timestamp - b.timestamp).slice(0, 8);
                document.getElementById('tv-waiting-list').innerHTML = waiting.map(q => `
                    <li class="flex items-center gap-4 text-slate-300">
                        <i class="fa-solid fa-circle text-xs text-yellow-500"></i>
                        <span class="font-mono font-bold text-4xl">${q.number}</span>
                    </li>
                `).join('');
            });
        };

        renderApp();
    </script>
</body>
</html>
